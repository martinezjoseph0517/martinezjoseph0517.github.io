{
  "hash": "a355d13b22b9b92cbeb063d81b783231",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"cal_taxes\"\nformat: html\neditor: visual\n---\n\n**DATA TABLES COMPLETE**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'readxl' was built under R version 4.5.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(DT)\n\n# Path to file\nfile_path <- \"C:/Users/marti/OneDrive/Desktop/test/taxes_cal.xlsx\"\n\n# Sheets you want to include\ntarget_sheets <- c(\n  \"CalReport by Cities 2017-2018\",\n  \"CalReport by Cities 2018-2019\",\n  \"CalReport by Cities 2019-2020\",\n  \"CalReport by Cities 2020-2021\",\n  \"CalReport by Cities 2021-2022\"\n)\n\n# Read only the specified sheets\nall_sheets <- lapply(target_sheets, function(s) {\n  read_excel(file_path, sheet = s)\n})\n\nnames(all_sheets) <- target_sheets\n\n# Loop through only the selected sheets\nfor (s in target_sheets) {\n  \n  # Read each selected sheet\n  sheet_data <- read_excel(file_path, sheet = s)\n  \n  # Print sheet title as a markdown header\n  cat(\"## Sheet:\", s, \"\\n\\n\")\n  \n  # Print interactive datatable\n  print(\n    datatable(\n      sheet_data,\n      options = list(\n        pageLength = 10,\n        autoWidth = TRUE,\n        scrollX = TRUE\n      ),\n      caption = paste(\"California TOT Data ‚Äî Sheet:\", s)\n    )\n  )\n  \n  cat(\"\\n\\n\")  # spacing between tables\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n## Sheet: CalReport by Cities 2017-2018 \n\n\n\n## Sheet: CalReport by Cities 2018-2019 \n\n\n\n## Sheet: CalReport by Cities 2019-2020 \n\n\n\n## Sheet: CalReport by Cities 2020-2021 \n\n\n\n## Sheet: CalReport by Cities 2021-2022 \n```\n\n\n:::\n:::\n\n\n**California Heat Maps**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\nlibrary(DT)\nlibrary(tigris)   # county shapefiles\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'tigris' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nTo enable caching of data, set `options(tigris_use_cache = TRUE)`\nin your R script or .Rprofile.\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(sf)       # spatial data\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'sf' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLinking to GEOS 3.13.1, GDAL 3.11.4, PROJ 9.7.0; sf_use_s2() is TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAdjuntando el paquete: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'ggplot2' was built under R version 4.5.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(reshape2)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'reshape2' was built under R version 4.5.2\n```\n\n\n:::\n\n```{.r .cell-code}\nsheet_names <- excel_sheets(\"C:/Users/marti/OneDrive/Desktop/test/taxes_cal.xlsx\")\n\n# Create a named list of sheets\nall_sheets <- lapply(sheet_names, function(s) {\n  read_excel(\"C:/Users/marti/OneDrive/Desktop/test/taxes_cal.xlsx\", sheet = s)\n})\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nNew names:\n‚Ä¢ `` -> `...8`\n```\n\n\n:::\n\n```{.r .cell-code}\nnames(all_sheets) <- sheet_names\n\n\noptions(tigris_use_cache = TRUE)\n\nfile_path <- \"C:/Users/marti/OneDrive/Desktop/test/taxes_cal.xlsx\"\nsheet_names <- excel_sheets(file_path)\n\n# Load CA county geometry\nca_counties <- counties(state = \"CA\", cb = TRUE, class = \"sf\") %>%\n  select(NAME, geometry) %>%\n  rename(County = NAME)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\n```\n\n\n:::\n\n```{.r .cell-code}\n# FUNCTION: Map cities to counties and aggregate\naggregate_cities_to_counties <- function(df, tax_col) {\n  # Rename first column to City\n  df <- df %>% rename(City = 1)\n  df <- df %>% mutate(City = trimws(City))\n  \n  # Remove any rows where City is NA or total/summary rows\n  df <- df %>% filter(!is.na(City), !grepl(\"total|statewide\", City, ignore.case = TRUE))\n  \n  # Convert tax column to numeric (in case it's character)\n  df[[tax_col]] <- as.numeric(df[[tax_col]])\n  \n  # Create city-to-county mapping for California\n  # This uses tigris to get place (city) geometries and find which county they're in\n  ca_places <- places(state = \"CA\", cb = TRUE, class = \"sf\")\n  ca_counties_full <- counties(state = \"CA\", cb = TRUE, class = \"sf\")\n  \n  # Get centroids of places and spatial join to counties\n  place_centroids <- st_centroid(ca_places)\n  place_county_map <- st_join(place_centroids, ca_counties_full) %>%\n    st_drop_geometry() %>%\n    select(place_name = NAME.x, county_name = NAME.y) %>%\n    distinct()\n  \n  # Try to match cities in your data to the place names\n  df <- df %>%\n    mutate(\n      # Clean city names for better matching\n      City_clean = gsub(\" city| town| City| Town\", \"\", City, ignore.case = TRUE),\n      City_clean = trimws(City_clean)\n    )\n  \n  # Join with county mapping\n  df_mapped <- df %>%\n    left_join(place_county_map, by = c(\"City_clean\" = \"place_name\"))\n  \n  # For unmatched cities, try fuzzy matching or manual fixes\n  unmatched <- df_mapped %>% filter(is.na(county_name))\n  if (nrow(unmatched) > 0) {\n    cat(\"Unmatched cities:\", paste(unmatched$City, collapse = \", \"), \"\\n\")\n  }\n  \n  # Aggregate by county\n  df_aggregated <- df_mapped %>%\n    filter(!is.na(county_name)) %>%\n    group_by(County = county_name) %>%\n    summarise(!!tax_col := sum(.data[[tax_col]], na.rm = TRUE), .groups = \"drop\")\n  \n  return(df_aggregated)\n}\n\n# Update FUNCTION: Create heatmap for one sheet\nmake_heatmap <- function(df, sheet_name, tax_col) {\n  # Select relevant columns\n  df <- df %>% select(County, all_of(tax_col))\n  \n  # Join with map data\n  map_data <- ca_counties %>%\n    left_join(df, by = \"County\")\n  \n  # Plot\n  p <- ggplot(map_data) +\n    geom_sf(aes(fill = .data[[tax_col]]), color = \"white\", size = 0.2) +\n    scale_fill_viridis_c(option = \"plasma\", na.value = \"grey90\") +\n    labs(\n      title = paste(\"California TOT Heat Map ‚Äî\", sheet_name),\n      fill = \"TOT ($)\"\n    ) +\n    theme_minimal()\n  \n  print(p)\n}\n\n# UPDATED LOOP THROUGH SHEETS\nheatmap_sheets <- c(\n  \"CalReport by Cities 2017-2018\",\n  \"CalReport by Cities 2018-2019\",\n  \"CalReport by Cities 2019-2020\",\n  \"CalReport by Cities 2020-2021\"\n)\n\nfor (i in seq_along(sheet_names)) {\n\n  sheet <- sheet_names[i]\n\n  # Skip all sheets not in heatmap list\n  if (!(sheet %in% heatmap_sheets)) {\n    cat(\"Skipping sheet:\", sheet, \"\\n\")\n    next\n  }\n\n  df <- read_excel(file_path, sheet = sheet)\n\n  cat(\"\\n=== Processing:\", sheet, \"===\\n\")\n  cat(\"Column names:\\n\")\n  print(colnames(df))\n  cat(\"\\n\")\n\n  # Sheets 1‚Äì4 in your workbook are still aggregated\n  if (i %in% 1:4) {\n    tax_col <- colnames(df)[grep(\"TransientOccupancy|Total Revenues\", colnames(df), ignore.case = TRUE)][1]\n    cat(\"Using column:\", tax_col, \"\\n\")\n    df <- aggregate_cities_to_counties(df, tax_col)\n  }\n\n  # Sheets 5‚Äì6 use county format\n  if (i %in% 5:6) {\n    tax_col <- colnames(df)[grep(\"Transient Occupancy\", colnames(df), ignore.case = TRUE)][1]\n    cat(\"Using column:\", tax_col, \"\\n\")\n\n    df <- df %>% rename(County = 1)\n    df <- df %>% mutate(County = trimws(County))\n    df <- df %>% select(County, all_of(tax_col))\n  }\n\n  if (is.na(tax_col) || length(tax_col) == 0) {\n    cat(\"WARNING: Tax column not found in sheet\", sheet, \"\\n\\n\")\n    next\n  }\n\n  make_heatmap(df, sheet, tax_col)\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Processing: CalReport by Cities 2017-2018 ===\nColumn names:\n[1] \"Entity Name\"                                        \n[2] \"Entity ID\"                                          \n[3] \"Fiscal Year\"                                        \n[4] \"Transient Occupancy Taxes_Functional Revenues_Taxes\"\n[5] \"Transient Occupancy Taxes_General Revenues_Taxes\"   \n[6] \"Transient Occupancy Taxes_Total Revenues_Taxes\"     \n[7] \"Total Taxes_Functional Revenues_\"                   \n[8] \"Total Taxes_General Revenues_\"                      \n[9] \"Total Taxes_Total Revenues_\"                        \n\nUsing column: Transient Occupancy Taxes_Total Revenues_Taxes \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnmatched cities: Amador, California City, Carmel-By-The-Sea, Cathedral City, Coronado, Crescent City, Culver City, Daly City, El Paso De Robles, Foster City, King City, Mt. Shasta, National City, Nevada City, Redwood City, San Buenaventura, Suisun City, Temple City, Union City, Yuba City \n```\n\n\n:::\n\n::: {.cell-output-display}\n![](cal_taxes_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Processing: CalReport by Cities 2018-2019 ===\nColumn names:\n[1] \"Entity Name\"                                        \n[2] \"Entity ID\"                                          \n[3] \"Fiscal Year\"                                        \n[4] \"Transient Occupancy Taxes_Functional Revenues_Taxes\"\n[5] \"Transient Occupancy Taxes_General Revenues_Taxes\"   \n[6] \"Transient Occupancy Taxes_Total Revenues_Taxes\"     \n[7] \"Total Taxes_Functional Revenues_\"                   \n[8] \"Total Taxes_General Revenues_\"                      \n[9] \"Total Taxes_Total Revenues_\"                        \n\nUsing column: Transient Occupancy Taxes_Total Revenues_Taxes \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnmatched cities: Amador, California City, Carmel-By-The-Sea, Cathedral City, Coronado, Crescent City, Culver City, Daly City, El Paso De Robles, Foster City, King City, Mt. Shasta, National City, Nevada City, Redwood City, San Buenaventura, Suisun City, Temple City, Union City, Yuba City \n```\n\n\n:::\n\n::: {.cell-output-display}\n![](cal_taxes_files/figure-html/unnamed-chunk-2-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Processing: CalReport by Cities 2019-2020 ===\nColumn names:\n[1] \"Entity Name\"                                        \n[2] \"Entity ID\"                                          \n[3] \"Fiscal Year\"                                        \n[4] \"Transient Occupancy Taxes_Functional Revenues_Taxes\"\n[5] \"Transient Occupancy Taxes_General Revenues_Taxes\"   \n[6] \"Transient Occupancy Taxes_Total Revenues_Taxes\"     \n[7] \"Total Taxes_Functional Revenues_\"                   \n[8] \"Total Taxes_General Revenues_\"                      \n[9] \"Total Taxes_Total Revenues_\"                        \n\nUsing column: Transient Occupancy Taxes_Total Revenues_Taxes \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnmatched cities: Amador, California City, Carmel-By-The-Sea, Cathedral City, Coronado, Crescent City, Culver City, Daly City, El Paso De Robles, Foster City, King City, Mt. Shasta, National City, Nevada City, Redwood City, San Buenaventura, Suisun City, Temple City, Union City, Yuba City \n```\n\n\n:::\n\n::: {.cell-output-display}\n![](cal_taxes_files/figure-html/unnamed-chunk-2-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Processing: CalReport by Cities 2020-2021 ===\nColumn names:\n[1] \"Entity Name\"                                        \n[2] \"Entity ID\"                                          \n[3] \"Fiscal Year\"                                        \n[4] \"Transient Occupancy Taxes_Functional Revenues_Taxes\"\n[5] \"Transient Occupancy Taxes_General Revenues_Taxes\"   \n[6] \"Transient Occupancy Taxes_Total Revenues_Taxes\"     \n[7] \"Total Taxes_Functional Revenues_\"                   \n[8] \"Total Taxes_General Revenues_\"                      \n[9] \"Total Taxes_Total Revenues_\"                        \n\nUsing column: Transient Occupancy Taxes_Total Revenues_Taxes \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in aggregate_cities_to_counties(df, tax_col): NAs introducidos por\ncoerci√≥n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnmatched cities: Amador, California City, Carmel-By-The-Sea, Cathedral City, Coronado, Crescent City, Culver City, Daly City, El Paso De Robles, Foster City, King City, La Canada Flintridge, Mt. Shasta, National City, Nevada City, Redwood City, San Buenaventura, Sand City, Suisun City, Temple City, Union City, Yuba City \n```\n\n\n:::\n\n::: {.cell-output-display}\n![](cal_taxes_files/figure-html/unnamed-chunk-2-4.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSkipping sheet: CalReport by Cities 2021-2022 \nSkipping sheet: CalReport by Cities 2022-2023 \nSkipping sheet: CalReport by Counties 2022-2023 \nSkipping sheet: Cal C&C TOT 2022-2023 \n```\n\n\n:::\n:::\n\n\n**Bar Chart**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\nlibrary(DT)\nlibrary(tigris)   # county shapefiles\nlibrary(sf)       # spatial data\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(reshape2)\nlibrary(scales)\n\nsheet_names <- excel_sheets(\"C:/Users/marti/OneDrive/Desktop/test/taxes_cal.xlsx\")\n\n# Create a named list of sheets\nall_sheets <- lapply(sheet_names, function(s) {\n  read_excel(\"C:/Users/marti/OneDrive/Desktop/test/taxes_cal.xlsx\", sheet = s)\n})\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nNew names:\n‚Ä¢ `` -> `...8`\n```\n\n\n:::\n\n```{.r .cell-code}\nnames(all_sheets) <- sheet_names\n\n\noptions(tigris_use_cache = TRUE)\n\nfile_path <- \"C:/Users/marti/OneDrive/Desktop/test/taxes_cal.xlsx\"\nsheet_names <- excel_sheets(file_path)\n\n# FUNCTION: Map cities to counties and aggregate\naggregate_cities_to_counties <- function(df, tax_col) {\n  # Rename first column to City\n  df <- df %>% rename(City = 1)\n  df <- df %>% mutate(City = trimws(City))\n  \n  # Remove any rows where City is NA or total/summary rows (including \"Grand Total\")\n  df <- df %>% filter(!is.na(City), !grepl(\"total|statewide|grand total\", City, ignore.case = TRUE))\n  \n  # Convert tax column to numeric (in case it's character)\n  df[[tax_col]] <- as.numeric(df[[tax_col]])\n  \n  # Create city-to-county mapping for California\n  # This uses tigris to get place (city) geometries and find which county they're in\n  ca_places <- places(state = \"CA\", cb = TRUE, class = \"sf\")\n  ca_counties_full <- counties(state = \"CA\", cb = TRUE, class = \"sf\")\n  \n  # Get centroids of places and spatial join to counties\n  place_centroids <- st_centroid(ca_places)\n  place_county_map <- st_join(place_centroids, ca_counties_full) %>%\n    st_drop_geometry() %>%\n    select(place_name = NAME.x, county_name = NAME.y) %>%\n    distinct()\n  \n  # Try to match cities in your data to the place names\n  df <- df %>%\n    mutate(\n      # Clean city names for better matching\n      City_clean = gsub(\" city| town| City| Town\", \"\", City, ignore.case = TRUE),\n      City_clean = trimws(City_clean)\n    )\n  \n  # Join with county mapping\n  df_mapped <- df %>%\n    left_join(place_county_map, by = c(\"City_clean\" = \"place_name\"))\n  \n  # For unmatched cities, try fuzzy matching or manual fixes\n  unmatched <- df_mapped %>% filter(is.na(county_name))\n  if (nrow(unmatched) > 0) {\n    cat(\"Unmatched cities:\", paste(unmatched$City, collapse = \", \"), \"\\n\")\n  }\n  \n  # Aggregate by county\n  df_aggregated <- df_mapped %>%\n    filter(!is.na(county_name)) %>%\n    group_by(County = county_name) %>%\n    summarise(!!tax_col := sum(.data[[tax_col]], na.rm = TRUE), .groups = \"drop\")\n  \n  return(df_aggregated)\n}\n\n# After the loop, create a comparison chart with TOP 10 counties per sheet\n# Sheets to exclude\nexclude_sheets <- c(\n  \"CalReport by Counties 2022-2023\",\n  \"Cal C&C TOT 2022-2023\"\n)\n\n# Filter out sheets\nsheet_names <- sheet_names[!sheet_names %in% exclude_sheets]\n\nall_top_counties <- data.frame()\n\nfor (i in seq_along(sheet_names)) {\n  \n  sheet <- sheet_names[i]\n  df <- read_excel(file_path, sheet = sheet)\n\n  cat(\"\\n=== Processing sheet\", i, \":\", sheet, \"===\\n\")\n  \n  # Choose column depending on sheet index\n  if (i %in% 1:4) {\n    tax_col <- colnames(df)[grep(\"TransientOccupancy|Total Revenues\", colnames(df), ignore.case = TRUE)][1]\n    df <- aggregate_cities_to_counties(df, tax_col)\n  } else {\n    tax_col <- colnames(df)[grep(\"Transient Occupancy\", colnames(df), ignore.case = TRUE)][1]\n    \n    df <- df %>%\n      select(1, all_of(tax_col))\n    \n    colnames(df)[1] <- \"County\"\n    \n    df <- df %>%\n      mutate(County = trimws(County)) %>%\n      filter(!grepl(\"grand total|total|statewide\", County, ignore.case = TRUE))\n  }\n\n  df[[tax_col]] <- as.numeric(df[[tax_col]])\n\n  # Get top 10\n  top_10 <- df %>%\n    filter(!is.na(.data[[tax_col]]), .data[[tax_col]] > 0) %>%\n    arrange(desc(.data[[tax_col]])) %>%\n    slice_head(n = 10) %>%\n    mutate(Sheet = sheet, Revenue = .data[[tax_col]]) %>%\n    select(Sheet, County, Revenue)\n\n  all_top_counties <- bind_rows(all_top_counties, top_10)\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Processing sheet 1 : CalReport by Cities 2017-2018 ===\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnmatched cities: Amador, California City, Carmel-By-The-Sea, Cathedral City, Coronado, Crescent City, Culver City, Daly City, El Paso De Robles, Foster City, King City, Mt. Shasta, National City, Nevada City, Redwood City, San Buenaventura, Suisun City, Temple City, Union City, Yuba City \n\n=== Processing sheet 2 : CalReport by Cities 2018-2019 ===\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnmatched cities: Amador, California City, Carmel-By-The-Sea, Cathedral City, Coronado, Crescent City, Culver City, Daly City, El Paso De Robles, Foster City, King City, Mt. Shasta, National City, Nevada City, Redwood City, San Buenaventura, Suisun City, Temple City, Union City, Yuba City \n\n=== Processing sheet 3 : CalReport by Cities 2019-2020 ===\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnmatched cities: Amador, California City, Carmel-By-The-Sea, Cathedral City, Coronado, Crescent City, Culver City, Daly City, El Paso De Robles, Foster City, King City, Mt. Shasta, National City, Nevada City, Redwood City, San Buenaventura, Suisun City, Temple City, Union City, Yuba City \n\n=== Processing sheet 4 : CalReport by Cities 2020-2021 ===\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in aggregate_cities_to_counties(df, tax_col): NAs introducidos por\ncoerci√≥n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRetrieving data for the year 2024\nRetrieving data for the year 2024\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nUnmatched cities: Amador, California City, Carmel-By-The-Sea, Cathedral City, Coronado, Crescent City, Culver City, Daly City, El Paso De Robles, Foster City, King City, La Canada Flintridge, Mt. Shasta, National City, Nevada City, Redwood City, San Buenaventura, Sand City, Suisun City, Temple City, Union City, Yuba City \n\n=== Processing sheet 5 : CalReport by Cities 2021-2022 ===\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: NAs introducidos por coerci√≥n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Processing sheet 6 : CalReport by Cities 2022-2023 ===\n```\n\n\n:::\n\n```{.r .cell-code}\n# üìå Force x-axis order EXACTLY as requested\ndesired_order <- c(\n  \"CalReport by Cities 2017-2018\",\n  \"CalReport by Cities 2018-2019\",\n  \"CalReport by Cities 2019-2020\",\n  \"CalReport by Cities 2020-2021\",\n  \"CalReport by Cities 2021-2022\",\n  \"CalReport by Cities 2022-2023\"\n)\n\n# Extract only the Second YEAR from each name\nyear_labels <- sub(\".*\\\\d{4}-(\\\\d{4}).*\", \"\\\\1\", desired_order)\n\n\nall_top_counties$Sheet <- factor(all_top_counties$Sheet, levels = desired_order)\n\n# üü¶ Plot stacked bar chart\nggplot(all_top_counties, aes(x = Sheet, y = Revenue, fill = County)) +\n  scale_x_discrete(\n  limits = desired_order,   # order stays the same\n  labels = year_labels      # labels get simplified\n) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  scale_y_continuous(labels = scales::comma) +\n  labs(\n    title = \"TOT Revenue per Year by County\",\n    x = \"Fiscal Year\",\n    y = \"TOT Revenue ($)\"\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    legend.position = \"right\"\n  ) +\n  guides(fill = guide_legend(ncol = 1))\n```\n\n::: {.cell-output-display}\n![](cal_taxes_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "cal_taxes_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}